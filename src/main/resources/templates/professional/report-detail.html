<th:block xmlns:th="http://www.thymeleaf.org">
<style>
    .report-detail-container {
        background: linear-gradient(135deg, #eef2ff 0%, #faf5ff 50%, #fef2f2 100%);
    }

    .header-card {
        border-left: 4px solid #9B7EDE;
        background: white;
    }

    .info-section {
        background: linear-gradient(135deg, rgba(155, 126, 222, 0.05) 0%, rgba(106, 142, 174, 0.05) 100%);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .score-card {
        border: 2px solid;
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .score-card.stress {
        border-color: #ffc107;
        background: rgba(255, 193, 7, 0.05);
    }

    .score-card.anxiety {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.05);
    }

    .score-card.wellbeing {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }

    .score-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .score-value {
        font-size: 2rem;
        font-weight: bold;
    }

    .concern-box {
        background: white;
        border-left: 4px solid #9B7EDE;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .badge-custom {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .button-group button {
        flex: 1;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-book {
        background: linear-gradient(135deg, #9B7EDE 0%, #8B6ECE 100%);
        color: white;
    }

    .btn-book:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(155, 126, 222, 0.3);
    }

    .btn-book:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .btn-book:disabled:hover {
        transform: none;
        box-shadow: none;
    }

    .btn-back {
        background: #f5f5f5;
        color: #333;
    }

    .btn-back:hover {
        background: #e9e9e9;
    }

    .timestamp {
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>

<div class="container-fluid p-4">
        <!-- Back Button -->
        <div class="row mb-4">
            <div class="col-12">
                <a href="/mentalhealthhub/professional/reports" class="btn btn-sm btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Reports
                </a>
            </div>
        </div>

        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="bg-white rounded-3 p-4 shadow-sm header-card">
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <span style="font-size: 2rem;">ðŸ“‹</span>
                        <div class="flex-grow-1">
                            <h1 class="mb-1">Report Detail</h1>
                            <p class="text-muted mb-0">View report and book appointment with student</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Information -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="info-section">
                    <h5 class="mb-3">
                        <i class="bi bi-person-circle"></i> Student Information
                    </h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Student Name</label>
                            <p class="fw-medium" th:text="${student != null ? student.name : 'Unknown'}">Student Name</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Student ID</label>
                            <p class="fw-medium" th:text="${student != null ? student.id : 'N/A'}">ID</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Email</label>
                            <p class="fw-medium" th:text="${student != null ? student.email : 'N/A'}">Email</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Role</label>
                            <p class="fw-medium" th:text="${student != null ? student.role : 'N/A'}">Role</p>
                        </div>
                    </div>
                </div>

                <!-- Report Information -->
                <div class="info-section">
                    <h5 class="mb-3">
                        <i class="bi bi-file-text"></i> Report Information
                    </h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Report Type</label>
                            <span class="badge badge-custom bg-info text-dark" th:text="${report.type}">Type</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Submitted Date</label>
                            <p class="fw-medium timestamp" th:text="${#temporals.format(report.submittedAt, 'yyyy-MM-dd HH:mm:ss')}">Date</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Priority Level</label>
                            <span class="badge badge-custom" 
                                  th:classappend="${report.urgency == 'urgent' ? ' bg-danger text-white' : (report.urgency == 'high' ? ' bg-warning text-dark' : (report.urgency == 'medium' ? ' bg-info text-dark' : ' bg-success text-white'))}"
                                  th:text="${report.urgency}">Priority</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted small">Status</label>
                            <span class="badge badge-custom bg-secondary text-white" th:text="${report.status}">Status</span>
                        </div>
                    </div>
                    
                </div>

                <!-- Concern Details -->
                <div class="info-section">
                    <h5 class="mb-3">
                        <i class="bi bi-chat-left-text"></i> Concern Details
                    </h5>
                    <div class="concern-box">
                        <p th:text="${report.description}">No description provided.</p>
                    </div>

                    <!-- Scheduled Appointment Info -->
                    <div class="row" id="scheduledAppointmentInfo" th:if="${report.status == 'scheduled' && appointment != null}">
                        <div class="col-12 mb-3">
                            <div class="alert alert-success" role="alert">
                                <i class="bi bi-check-circle"></i> <strong>Appointment Scheduled</strong>
                                <br>
                                <small id="appointmentDetails">
                                    <strong>Date:</strong> <span th:text="${#temporals.format(appointment.appointmentDate, 'yyyy-MM-dd')}"></span><br>
                                    <strong>Start Time:</strong> <span th:text="${appointment.timeSlotStart}"></span><br>
                                    <strong>End Time:</strong> <span th:text="${appointment.timeSlotEnd}"></span><br>
                                    <strong>Status:</strong> <span th:text="${appointment.status}"></span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Student Suggested Appointment (When report is reviewed and suggestion exists) -->
                    <div class="row" id="studentSuggestionInfo" th:if="${report.status == 'reviewed' && suggestedAppointment != null && suggestedAppointment.suggestedAppointmentDate != null}">
                        <div class="col-12 mb-3">
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-chat-right-heart"></i> <strong>Student's Counter-Proposal</strong>
                                <br>
                                <small>
                                    <strong>Original Proposal:</strong><br>
                                    &nbsp;&nbsp;Date: <span th:text="${#temporals.format(suggestedAppointment.appointmentDate, 'yyyy-MM-dd')}"></span><br>
                                    &nbsp;&nbsp;Time: <span th:text="${suggestedAppointment.timeSlotStart}"></span> - <span th:text="${suggestedAppointment.timeSlotEnd}"></span>
                                    <hr style="margin: 0.5rem 0;">
                                    <strong>Student's Suggested Time:</strong><br>
                                    &nbsp;&nbsp;Date: <span th:text="${#temporals.format(suggestedAppointment.suggestedAppointmentDate, 'yyyy-MM-dd')}"></span><br>
                                    &nbsp;&nbsp;Time: <span th:text="${suggestedAppointment.suggestedTimeSlotStart}"></span> - <span th:text="${suggestedAppointment.suggestedTimeSlotEnd}"></span>
                                </small>
                                <br>
                                <button type="button" class="btn btn-sm btn-primary mt-3" th:onclick="'scheduleFromSuggestion(' + ${suggestedAppointment.id} + ')'">
                                    <i class="bi bi-check-circle"></i> Schedule This Time
                                </button>
                                <button type="button" class="btn btn-sm btn-warning mt-3" data-bs-toggle="modal" data-bs-target="#appointmentModal">
                                    <i class="bi bi-pencil-square"></i> Propose Different Time
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resolution Details -->
                <div th:if="${report.status == 'resolved' || report.status == 'closed'}" class="info-section">
                    <h5 class="mb-3">
                        <i class="bi bi-check-circle me-2"></i>Resolution Details
                    </h5>
                    <div class="concern-box" th:if="${report.resolutionNotes}">
                        <h6 style="color: #9B7EDE; margin-bottom: 1rem;">Resolution Notes</h6>
                        <p th:text="${report.resolutionNotes}">No notes provided</p>
                    </div>
                    <small class="text-muted d-block mt-2" th:if="${report.resolvedAt}">
                        <i class="bi bi-check-lg me-2"></i>
                        <span>Resolved on: <strong th:text="${#temporals.format(report.resolvedAt, 'MMM dd, yyyy HH:mm')}">Date</strong></span>
                    </small>
                </div>
            </div>

            <!-- Mental Health Scores -->
            <div class="col-lg-4">
                <div class="info-section" style="background: white; border: 2px solid #9B7EDE;">
                    <h5 class="mb-4">
                        <i class="bi bi-graph-up"></i> Mental Health Scores
                    </h5>

                    <!-- Stress Level -->
                    <div class="score-card stress mb-3">
                        <div class="score-label">Stress Level</div>
                        <div class="score-value" th:text="${student != null && student.stressLevel != null ? student.stressLevel : '-'}">-</div>
                        <small class="text-muted">/100</small>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-warning" 
                                 th:style="${student != null && student.stressLevel != null ? 'width: ' + student.stressLevel + '%' : 'width: 0%'}"></div>
                        </div>
                    </div>

                    <!-- Anxiety Level -->
                    <div class="score-card anxiety mb-3">
                        <div class="score-label">Anxiety Level</div>
                        <div class="score-value" th:text="${student != null && student.anxietyLevel != null ? student.anxietyLevel : '-'}">-</div>
                        <small class="text-muted">/100</small>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-danger" 
                                 th:style="${student != null && student.anxietyLevel != null ? 'width: ' + student.anxietyLevel + '%' : 'width: 0%'}"></div>
                        </div>
                    </div>

                    <!-- Wellbeing Score -->
                    <div class="score-card wellbeing mb-3">
                        <div class="score-label">Overall Wellbeing</div>
                        <div class="score-value" th:text="${student != null && student.wellbeingScore != null ? student.wellbeingScore : '-'}">-</div>
                        <small class="text-muted">/100</small>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-success" 
                                 th:style="${student != null && student.wellbeingScore != null ? 'width: ' + student.wellbeingScore + '%' : 'width: 0%'}"></div>
                        </div>
                    </div>

                    <!-- Overall Score Summary (S/A/D) -->
                    <div style="background: linear-gradient(135deg, rgba(155, 126, 222, 0.1) 0%, rgba(155, 126, 222, 0.05) 100%); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #9B7EDE;">
                        <h6 class="mb-3" style="color: #9B7EDE; font-weight: 600;">
                            <i class="bi bi-speedometer2"></i> Overall Score (S/A/D)
                        </h6>
                        <div style="display: flex; gap: 1rem; justify-content: center; align-items: center;">
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 2rem; font-weight: bold; color: #ffc107;">
                                    <span th:text="${student != null && student.stressLevel != null ? student.stressLevel : '-'}">-</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem;">Stress (S)</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 2rem; font-weight: bold; color: #dc3545;">
                                    <span th:text="${student != null && student.anxietyLevel != null ? student.anxietyLevel : '-'}">-</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem;">Anxiety (A)</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 2rem; font-weight: bold; color: #6f42c1;">
                                    <span th:text="${student != null && student.wellbeingScore != null ? student.wellbeingScore : '-'}">-</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem;">Depression (D)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Last Assessment -->
                    <div class="alert alert-info mt-4" style="font-size: 0.9rem;">
                        <i class="bi bi-info-circle"></i>
                        <span th:if="${student != null && student.lastAssessmentDate != null}">
                            Last assessment: <span th:text="${#temporals.format(student.lastAssessmentDate, 'yyyy-MM-dd')}">date</span>
                        </span>
                        <span th:if="${student == null || student.lastAssessmentDate == null}">
                            No assessment record available
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row">
            <div class="col-lg-8">
                <div class="button-group">
                    <a th:if="${student != null}" th:href="@{/professional/students/{id}(id=${student.id})}" class="btn-book" style="display: flex; align-items: center; justify-content: center; text-decoration: none; gap: 0.75rem; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(155, 126, 222, 0.2); transition: all 0.3s ease;">
                        <i class="bi bi-person-circle" style="font-size: 1.25rem;"></i> View Patient Detail
                    </a>
                    <!-- Schedule Appointment button - disabled if student has pending suggestion, enabled for other cases -->
                    <button type="button" class="btn-book" data-bs-toggle="modal" data-bs-target="#appointmentModal" 
                            th:if="${user.role.name() == 'PROFESSIONAL' && report.status != 'scheduled' && report.status != 'resolved'}"
                            th:disabled="${report.status == 'reviewed' && suggestedAppointment != null && suggestedAppointment.suggestedAppointmentDate != null}"
                            th:title="${report.status == 'reviewed' && suggestedAppointment != null && suggestedAppointment.suggestedAppointmentDate != null ? T(java.lang.String).format('Please respond to %s suggestion first', 'student') : ''}">
                        <i class="bi bi-calendar-plus"></i> Schedule Appointment
                    </button>
                    <!-- Mark as Resolved button - only for professionals -->
                    <button type="button" class="btn-book" data-bs-toggle="modal" data-bs-target="#resolveModal" th:if="${user.role.name() == 'PROFESSIONAL' && report.status != 'resolved'}">
                        <i class="bi bi-check-circle"></i> Mark as Resolved
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div class="modal fade" id="appointmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Schedule Appointment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="appointmentForm" method="POST" th:action="@{/appointments/book}">
                    <div class="modal-body">
                        <p class="text-muted mb-4">Choose a date and continuous time slots for the appointment with <strong th:text="${student != null ? student.name : 'Student'}">Student</strong></p>
                        
                        <input type="hidden" name="reportId" th:value="${report.id}">
                        <input type="hidden" name="studentId" th:value="${student != null ? student.id : ''}">
                        <input type="hidden" name="appointmentTime" id="appointmentTime">
                        <input type="hidden" name="appointmentDuration" id="appointmentDuration">

                        <div class="mb-3">
                            <label class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="appointmentDate" name="appointmentDate" required>
                            <small class="text-muted">Select a date for the appointment (today or later)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Available Time Slots <span class="text-danger">*</span></label>
                            <div id="timeSlotsContainer" class="row g-2">
                                <div class="col-12">
                                    <p class="text-muted" id="noSlotsMessage">Select a date to see available time slots</p>
                                </div>
                            </div>
                            <small class="text-danger d-none" id="timeSlotError">Please select continuous time slots</small>
                        </div>

                        <div class="alert alert-info d-none" id="slotSelectionInfo" role="alert">
                            <small><strong>Selected:</strong> <span id="selectedSlotsDisplay">No slots selected</span></small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" name="notes" rows="3" placeholder="Add any notes for this appointment..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn text-white" style="background: linear-gradient(135deg, #9B7EDE 0%, #8B6ECE 100%);">
                            <i class="bi bi-check-circle"></i> Confirm Appointment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Resolve Modal -->
    <div class="modal fade" id="resolveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark Report as Resolved</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" th:action="@{/professional/reports/{id}/resolve(id=${report.id})}">
                    <div class="modal-body">
                        <p class="text-muted mb-4">Add resolution notes for this report</p>
                        
                        <input type="hidden" name="reportId" th:value="${report.id}">

                        <div class="mb-3">
                            <label class="form-label">Resolution Notes</label>
                            <textarea class="form-control" name="resolutionNotes" rows="5" placeholder="Describe the resolution or actions taken..." required></textarea>
                            <small class="text-muted d-block mt-2">This will be recorded as the resolution for this report.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn text-white" style="background: linear-gradient(135deg, #9B7EDE 0%, #8B6ECE 100%);">
                            <i class="bi bi-check-circle"></i> Confirm Resolution
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentProfessionalId = null;
        let allAvailableSlots = [];
        let selectedSlots = [];

        // Set minimum date to today
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;
        document.getElementById('appointmentDate').min = todayStr;

        // Fetch professional info from session
        fetch('/mentalhealthhub/appointments/api/current-user')
            .then(response => response.json())
            .then(data => {
                currentProfessionalId = data.id;
            })
            .catch(error => console.error('Error loading professional info:', error));

        // Appointment details are now rendered server-side by Thymeleaf
        // No need to fetch via API anymore

        // Handle appointment date change
        document.getElementById('appointmentDate')?.addEventListener('change', function() {
            selectedSlots = [];
            if (this.value) {
                loadAvailableTimeSlots(this.value);
            }
        });

        // Load available time slots for selected date
        function loadAvailableTimeSlots(date) {
            const studentId = document.querySelector('input[name="studentId"]').value;
            const container = document.getElementById('timeSlotsContainer');
            const noSlotsMessage = document.getElementById('noSlotsMessage');
            
            if (!currentProfessionalId) {
                container.innerHTML = '<div class="col-12"><p class="text-muted">Loading professional info...</p></div>';
                setTimeout(() => loadAvailableTimeSlots(date), 500);
                return;
            }
            
            container.innerHTML = '<div class="col-12"><p class="text-muted">Loading available slots...</p></div>';
            
            // Fetch available slots for the professional on the selected date
            fetch(`/mentalhealthhub/appointments/api/available-slots?studentId=${studentId}&date=${date}&professionalId=${currentProfessionalId}`)
                .then(response => response.json())
                .then(data => {
                    allAvailableSlots = [];
                    if (data.slots) {
                        allAvailableSlots = data.slots.map(s => s.display);
                    }
                    
                    if (!allAvailableSlots || allAvailableSlots.length === 0) {
                        container.innerHTML = '<div class="col-12"><p class="text-muted text-center py-3">No available time slots for this date</p></div>';
                        return;
                    }
                    
                    // Sort time slots by time
                    allAvailableSlots.sort((a, b) => {
                        const timeA = a.split('-')[0].trim();
                        const timeB = b.split('-')[0].trim();
                        return timeA.localeCompare(timeB);
                    });
                    
                    // Filter out past time slots if date is today
                    const today = new Date();
                    const selectedDate = new Date(date + 'T00:00:00');
                    const isToday = today.toDateString() === selectedDate.toDateString();
                    
                    if (isToday) {
                        const currentHour = today.getHours();
                        const currentMinutes = today.getMinutes();
                        const currentTime = `${String(currentHour).padStart(2, '0')}:${String(currentMinutes).padStart(2, '0')}`;
                        
                        // Filter out slots that have already passed
                        allAvailableSlots = allAvailableSlots.filter(slot => {
                            const startTime = slot.split('-')[0].trim();
                            // Parse time (handle both 24-hour and 12-hour format)
                            let [hours, minutes] = startTime.split(':');
                            hours = parseInt(hours);
                            minutes = parseInt(minutes);
                            
                            // Check if this slot starts in the future
                            return hours > currentHour || (hours === currentHour && minutes > currentMinutes);
                        });
                    }
                    
                    let html = '';
                    allAvailableSlots.forEach((slot, index) => {
                        const timeRange = slot.split('-');
                        const startTime = timeRange[0].trim();
                        // Filter out lunch break (13:00 - 14:00)
                        if (startTime === '13:00' || startTime === '1:00 PM') {
                            return; // Skip lunch break slot
                        }
                        const slotId = `slot_${startTime.replace(':', '_')}`;
                        html += `
                            <div class="col-md-6">
                                <input type="checkbox" class="btn-check time-slot-checkbox" data-index="${index}" id="${slotId}" value="${startTime}" onchange="handleSlotSelection(${index}, '${startTime}')">
                                <label class="btn btn-outline-primary w-100" for="${slotId}" style="cursor: pointer;">
                                    <i class="bi bi-clock"></i> ${slot}
                                </label>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    if (noSlotsMessage) {
                        noSlotsMessage.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading time slots:', error);
                    container.innerHTML = '<div class="col-12"><p class="text-danger text-center py-3">Error loading available slots</p></div>';
                });
        }

        // Handle slot selection with continuous validation
        function handleSlotSelection(index, startTime) {
            const checkbox = document.querySelector(`input[id="slot_${startTime.replace(':', '_')}"]`);
            
            if (checkbox.checked) {
                selectedSlots.push(index);
            } else {
                selectedSlots = selectedSlots.filter(idx => idx !== index);
            }
            
            // Validate that selected slots are time-continuous (no gaps in actual times)
            if (selectedSlots.length > 1) {
                selectedSlots.sort((a, b) => a - b);
                
                // Check if the actual times are continuous (end time of one slot = start time of next)
                let isContinuous = true;
                for (let i = 0; i < selectedSlots.length - 1; i++) {
                    const currentSlotIndex = selectedSlots[i];
                    const nextSlotIndex = selectedSlots[i + 1];
                    
                    // Get the end time of current slot
                    const currentSlotText = allAvailableSlots[currentSlotIndex];
                    const currentEndTime = currentSlotText.split('-')[1].trim();
                    
                    // Get the start time of next slot
                    const nextSlotText = allAvailableSlots[nextSlotIndex];
                    const nextStartTime = nextSlotText.split('-')[0].trim();
                    
                    // Check if end time of current equals start time of next
                    if (currentEndTime !== nextStartTime) {
                        isContinuous = false;
                        console.log(`Gap detected: ${currentEndTime} != ${nextStartTime}`);
                        break;
                    }
                }
                
                if (!isContinuous) {
                    // Uncheck the slot
                    checkbox.checked = false;
                    selectedSlots = selectedSlots.filter(idx => idx !== index);
                    alert('Please select continuous time slots without gaps. Times must be back-to-back (e.g., 11:00-11:30 and 11:30-12:00 are continuous).');
                    return;
                }
            }
            
            updateSlotDisplay();
        }

        // Update the display of selected slots
        function updateSlotDisplay() {
            if (selectedSlots.length === 0) {
                document.getElementById('slotSelectionInfo').classList.add('d-none');
                document.getElementById('appointmentTime').value = '';
                document.getElementById('appointmentDuration').value = '';
                return;
            }
            
            selectedSlots.sort((a, b) => a - b);
            const startSlotIndex = selectedSlots[0];
            const endSlotIndex = selectedSlots[selectedSlots.length - 1];
            
            const startTime = allAvailableSlots[startSlotIndex].split('-')[0].trim();
            const endTime = allAvailableSlots[endSlotIndex].split('-')[1].trim();
            
            const selectedDisplay = startTime + ' - ' + endTime;
            
            document.getElementById('selectedSlotsDisplay').textContent = selectedDisplay;
            document.getElementById('slotSelectionInfo').classList.remove('d-none');
            document.getElementById('appointmentTime').value = startTime;
            document.getElementById('appointmentDuration').value = selectedSlots.length;
        }

        // Handle form submission
        document.getElementById('appointmentForm')?.addEventListener('submit', function(e) {
            const timeSlot = document.getElementById('appointmentTime').value;
            if (!timeSlot || selectedSlots.length === 0) {
                e.preventDefault();
                document.getElementById('timeSlotError').classList.remove('d-none');
                return;
            }
            
            // Validate continuous slots before submission
            if (selectedSlots.length > 1) {
                const sortedSlots = [...selectedSlots].sort((a, b) => a - b);
                let isContinuous = true;
                
                for (let i = 0; i < sortedSlots.length - 1; i++) {
                    const currentSlotIndex = sortedSlots[i];
                    const nextSlotIndex = sortedSlots[i + 1];
                    
                    const currentSlotText = allAvailableSlots[currentSlotIndex];
                    const currentEndTime = currentSlotText.split('-')[1].trim();
                    
                    const nextSlotText = allAvailableSlots[nextSlotIndex];
                    const nextStartTime = nextSlotText.split('-')[0].trim();
                    
                    if (currentEndTime !== nextStartTime) {
                        isContinuous = false;
                        break;
                    }
                }
                
                if (!isContinuous) {
                    e.preventDefault();
                    document.getElementById('timeSlotError').classList.remove('d-none');
                    document.getElementById('timeSlotError').innerHTML = '<small class="text-danger">Please select continuous time slots without gaps</small>';
                    return;
                }
            }
            document.getElementById('timeSlotError').classList.add('d-none');
            
            // Get report ID and update status after appointment is created
            const reportId = document.querySelector('input[name="reportId"]').value;
            const appointmentDate = document.getElementById('appointmentDate').value;
            const appointmentTime = document.getElementById('appointmentTime').value;
            
            // Store values for post-submission handling
            this.dataset.reportId = reportId;
            this.dataset.appointmentDate = appointmentDate;
            this.dataset.appointmentTime = appointmentTime;
            
            // Schedule the status update to happen after the redirect
            // Save to sessionStorage so we can retrieve it after redirect
            if (reportId) {
                sessionStorage.setItem('appointmentFormSubmitted_reportId', reportId);
                sessionStorage.setItem('appointmentFormSubmitted_time', new Date().getTime());
            }
        });

        // Check if we just redirected from appointment booking and need to update status
        window.addEventListener('load', function() {
            const reportId = sessionStorage.getItem('appointmentFormSubmitted_reportId');
            const submitTime = sessionStorage.getItem('appointmentFormSubmitted_time');
            
            if (reportId && submitTime) {
                const timeDiff = new Date().getTime() - parseInt(submitTime);
                // If less than 5 seconds, we just redirected
                if (timeDiff < 5000) {
                    // Update report status to 'scheduled'
                    fetch(`/mentalhealthhub/concerns/api/${reportId}/status?status=scheduled`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Report status updated to scheduled:', data);
                        // Refresh the page to show updated status
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    })
                    .catch(error => {
                        console.error('Error updating report status:', error);
                        // Still refresh to show the new appointment
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    });
                    
                    // Clear the session storage
                    sessionStorage.removeItem('appointmentFormSubmitted_reportId');
                    sessionStorage.removeItem('appointmentFormSubmitted_time');
                }
            }
        });

        // Schedule appointment from student's suggestion
        function scheduleFromSuggestion(appointmentId) {
            if (confirm('Schedule appointment with the suggested time?')) {
                fetch(`/mentalhealthhub/appointments/${appointmentId}/professional-schedule-suggestion`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text); });
                    }
                    return response.json();
                })
                .then(data => {
                    alert('Appointment scheduled successfully!');
                    location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to schedule appointment: ' + error.message);
                });
            }
        }
    </script>
</th:block>
