<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Appointments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .calendar-container {
            padding: 0;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 10px;
        }

        .calendar-grid table {
            width: 100%;
            border-collapse: collapse;
        }

        .calendar-grid tbody td {
            text-align: center;
            padding: 10px 2px;
            cursor: pointer;
            font-size: 0.9rem;
            height: 40px;
            border: 1px solid #e9ecef;
            user-select: none;
            transition: all 0.2s ease;
        }

        .calendar-grid tbody td:hover:not(.other-month) {
            background-color: #e9ecef;
            font-weight: bold;
        }

        .calendar-grid tbody td.other-month {
            color: #ccc;
            background-color: #fff;
            cursor: not-allowed;
        }

        .calendar-grid tbody td.today {
            font-weight: bold;
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .calendar-grid tbody td.selected {
            background-color: #0056b3;
            color: white;
            font-weight: bold;
            border-color: #0056b3;
        }

        .appointment-card {
            border-left: 4px solid #6A8EAE;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .appointment-card.urgent {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .appointment-card.confirmed {
            border-left-color: #28a745;
            background: #f0f9f6;
        }

        .appointment-time {
            font-size: 1.1rem;
            font-weight: bold;
            color: #6A8EAE;
        }

        .appointment-type {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .appointment-patient {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }

        .patient-info {
            font-size: 0.9rem;
        }

        .patient-number {
            font-weight: bold;
            color: #333;
        }

        .btn-small {
            padding: 4px 12px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="row mb-4">
            <div class="col-md-12">
                <h1 class="mb-2">Manage Appointments</h1>
                <p class="text-muted">View and manage your telehealth sessions</p>
            </div>
        </div>

        <div class="row">
            <!-- Left: Calendar -->
            <div class="col-lg-3">
                <div class="card">
                    <div class="card-body">
                        <div class="calendar-container">
                            <div class="calendar-header d-flex align-items-center justify-content-between mb-3">
                                <button id="prevMonth" class="btn btn-sm btn-outline-secondary" style="padding: 4px 8px;">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <h6 id="monthYear" class="mb-0" style="flex: 1; text-align: center;">December 2025</h6>
                                <button id="nextMonth" class="btn btn-sm btn-outline-secondary" style="padding: 4px 8px;">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                            <div class="calendar-grid">
                                <table class="table table-sm table-bordered" style="margin: 0; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th class="text-center small" style="padding: 8px 4px;">Su</th>
                                            <th class="text-center small" style="padding: 8px 4px;">Mo</th>
                                            <th class="text-center small" style="padding: 8px 4px;">Tu</th>
                                            <th class="text-center small" style="padding: 8px 4px;">We</th>
                                            <th class="text-center small" style="padding: 8px 4px;">Th</th>
                                            <th class="text-center small" style="padding: 8px 4px;">Fr</th>
                                            <th class="text-center small" style="padding: 8px 4px;">Sa</th>
                                        </tr>
                                    </thead>
                                    <tbody id="calendarDays">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Appointments List -->
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-header border-0 pb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">Appointments for <span id="selectedDate">today</span></h6>
                                <small class="text-muted" id="appointmentCount">0 sessions scheduled</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="appointmentsContainer">
                            <div class="text-center py-5">
                                <i class="bi bi-calendar-x" style="font-size: 3rem; color: #ddd;"></i>
                                <p class="text-muted mt-3">No appointments scheduled for this date</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        let currentDate = new Date();
        let selectedDate = new Date();
        let currentUser = null;
        
        // Load appointments data from API instead of Thymeleaf inline (better compatibility)
        let appointmentsData = [];
        
        // Fetch appointments from API
        console.log('Fetching appointments from API endpoint...');
        fetch('/mentalhealthhub/appointments/api/my-schedule')
            .then(response => response.json())
            .then(data => {
                appointmentsData = data;
                console.log('✓ Successfully loaded', appointmentsData.length, 'appointments from API');
                console.log('Appointments data:', appointmentsData);
                
                // Convert date strings to Date objects
                appointmentsData.forEach((apt, index) => {
                    console.log(`Processing appointment ${index}:`, apt);
                    
                    // Convert ISO string to Date
                    if (typeof apt.appointmentDate === 'string') {
                        apt.appointmentDate = new Date(apt.appointmentDate);
                        console.log(`  ✓ Converted date string to Date:`, apt.appointmentDate);
                    }
                });
                
                // Initialize the calendar after data is loaded
                renderCalendar();
                displayAppointmentsForDate(selectedDate);
            })
            .catch(error => {
                console.error('✗ Error loading appointments from API:', error);
                // Initialize calendar even if data load fails
                renderCalendar();
                displayAppointmentsForDate(selectedDate);
            });
        
        // Fetch current user info from session
        fetch('/mentalhealthhub/appointments/api/current-user')
            .then(response => response.json())
            .then(data => {
                currentUser = data;
                console.log('Current user:', currentUser);
            })
            .catch(error => {
                console.error('Error loading current user:', error);
            });
        
        console.log('Initial appointments array setup (will be populated by API)');


        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month year display
            document.getElementById('monthYear').textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayOfWeek = firstDay.getDay();
            const lastDateOfMonth = lastDay.getDate();
            const lastDayOfWeek = lastDay.getDay();
            const prevLastDate = prevLastDay.getDate();
            
            const calendarBody = document.getElementById('calendarDays');
            calendarBody.innerHTML = '';
            
            let row = document.createElement('tr');
            let cellCount = 0;
            
            // Previous month days
            for (let i = firstDayOfWeek; i > 0; i--) {
                const td = document.createElement('td');
                td.textContent = prevLastDate - i + 1;
                td.classList.add('other-month');
                row.appendChild(td);
                cellCount++;
            }
            
            // Current month days
            for (let i = 1; i <= lastDateOfMonth; i++) {
                if (cellCount === 7) {
                    calendarBody.appendChild(row);
                    row = document.createElement('tr');
                    cellCount = 0;
                }
                
                const td = document.createElement('td');
                td.textContent = i;
                
                const date = new Date(year, month, i);
                const dateStr = date.toDateString();
                const todayStr = new Date().toDateString();
                const selectedStr = selectedDate.toDateString();
                
                if (dateStr === todayStr) {
                    td.classList.add('today');
                }
                if (dateStr === selectedStr) {
                    td.classList.add('selected');
                }
                
                td.addEventListener('click', () => selectDate(new Date(year, month, i)));
                row.appendChild(td);
                cellCount++;
            }
            
            // Next month days
            const nextMonthDays = 6 - lastDayOfWeek;
            for (let i = 1; i <= nextMonthDays; i++) {
                if (cellCount === 7) {
                    calendarBody.appendChild(row);
                    row = document.createElement('tr');
                    cellCount = 0;
                }
                const td = document.createElement('td');
                td.textContent = i;
                td.classList.add('other-month');
                row.appendChild(td);
                cellCount++;
            }
            
            // Append the last row if it has content
            if (cellCount > 0) {
                calendarBody.appendChild(row);
            }
        }

        function selectDate(date) {
            selectedDate = new Date(date);
            renderCalendar();
            displayAppointmentsForDate(selectedDate);
        }

        function displayAppointmentsForDate(date) {
            const dateStr = formatDateForComparison(date);
            console.log('=== Displaying appointments for date:', dateStr, '(', date.toDateString(), ')');
            document.getElementById('selectedDate').textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            
            console.log('Total appointments to check:', appointmentsData.length);
            
            const appointmentsForDate = appointmentsData.filter(apt => {
                const aptDate = apt.appointmentDate;
                
                if (!aptDate) {
                    console.warn('Appointment has no date:', apt);
                    return false;
                }
                
                if (!(aptDate instanceof Date) || isNaN(aptDate.getTime())) {
                    console.warn('Invalid appointment date object:', aptDate, 'for appointment:', apt);
                    return false;
                }
                
                const aptDateStr = formatDateForComparison(aptDate);
                const match = aptDateStr === dateStr;
                
                if (match) {
                    console.log('✓ MATCH - Appointment date:', aptDateStr, '===', dateStr);
                } else {
                    console.log('✗ NO MATCH - Appointment date:', aptDateStr, '!==', dateStr);
                }
                
                return match;
            });
            
            console.log('=== Found', appointmentsForDate.length, 'appointments for date:', dateStr);
            
            const container = document.getElementById('appointmentsContainer');
            const count = appointmentsForDate.length;
            document.getElementById('appointmentCount').textContent = count + ' session' + (count !== 1 ? 's' : '') + ' scheduled';
            
            if (appointmentsForDate.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #ddd;"></i>
                        <p class="text-muted mt-3">No appointments scheduled for this date</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            appointmentsForDate.forEach(apt => {
                const time = apt.appointmentDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const cardClass = apt.status === 'CANCELLED' ? 'urgent' : apt.status === 'COMPLETED' ? 'confirmed' : '';
                const badgeClass = apt.status === 'CANCELLED' ? 'danger' : apt.status === 'COMPLETED' ? 'success' : (apt.status === 'PENDING' ? 'warning' : 'info');
                const studentName = apt.student ? apt.student.name : 'Unknown Student';
                const studentId = apt.student ? apt.student.id : 'N/A';
                const isProfessional = currentUser && (currentUser.role === 'PROFESSIONAL' || currentUser.role === 'ADMIN');
                
                // Show notes if they exist
                let notesHtml = '';
                if (apt.notes && apt.notes.trim()) {
                    notesHtml = `
                        <div class="mt-3 p-2 bg-white rounded border-left border-info">
                            <small class="text-muted"><i class="bi bi-chat-left-text"></i> <strong>Notes:</strong></small>
                            <p class="mb-0 mt-1">${apt.notes}</p>
                        </div>
                    `;
                }
                
                // Show "View Student" button only for professionals
                let viewStudentBtn = '';
                if (isProfessional) {
                    viewStudentBtn = `
                        <a href="/mentalhealthhub/professional/students/${studentId}" class="btn btn-outline-secondary btn-small">
                            <i class="bi bi-person-circle"></i> View Student
                        </a>
                    `;
                }
                
                html += `
                    <div class="appointment-card ${cardClass}">
                        <div class="appointment-time">⏰ ${time}</div>
                        <div class="appointment-type">Initial Consultation</div>
                        <div class="appointment-patient">
                            <div class="patient-info">
                                Patient <span class="patient-number">#${studentId}</span>
                                <span class="badge bg-${badgeClass} ms-2">${apt.status}</span>
                            </div>
                            <div class="patient-info mt-2">${studentName}</div>
                        </div>
                        ${notesHtml}
                        <div class="mt-3">
                            <button class="btn btn-primary btn-small me-2">
                                <i class="bi bi-telephone"></i> Join
                            </button>
                            ${viewStudentBtn}
                            <button class="btn btn-outline-danger btn-small float-end" onclick="deleteAppointment(${apt.id}, this)">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function formatDateForComparison(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Event listeners for month navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            renderCalendar();
        });

        // Calendar will be initialized after appointments are loaded from API
        
        function deleteAppointment(appointmentId, button) {
            if (!confirm('Are you sure you want to reject this appointment?')) {
                return;
            }

            fetch(`/mentalhealthhub/appointments/api/${appointmentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Remove the appointment card from the UI
                    const card = button.closest('.appointment-card');
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(-100%)';
                    card.style.transition = 'all 0.3s ease';
                    
                    setTimeout(() => {
                        // Remove from data array
                        appointmentsData = appointmentsData.filter(apt => apt.id !== appointmentId);
                        // Refresh the display
                        displayAppointmentsForDate(selectedDate);
                    }, 300);
                    
                    return response.json();
                } else if (response.status === 401) {
                    alert('You are not authorized to delete this appointment');
                } else if (response.status === 403) {
                    alert('You do not have permission to delete this appointment');
                } else if (response.status === 404) {
                    alert('Appointment not found');
                } else {
                    throw new Error('Failed to delete appointment');
                }
            })
            .catch(error => {
                console.error('Error deleting appointment:', error);
                alert('Error deleting appointment. Please try again.');
            });
        }
    </script>
</body>
</html>