<!-- Professional Rejected Appointments View -->
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-2"><i class="bi bi-calendar-x"></i> Rejected Appointments</h1>
            <p class="text-muted">Review appointments you have rejected</p>
        </div>
        <div class="col-md-4 text-end">
            <a th:href="@{/appointments/my-schedule}" class="btn btn-primary">
                <i class="bi bi-arrow-left"></i> Back to Schedule
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Calendar Section (Left) -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-body" style="padding: 15px;">
                    <label style="font-weight: 600; color: #333; margin-bottom: 15px; display: block;">
                        <i class="bi bi-calendar"></i> Select Date
                    </label>
                    <div id="calendarContainer" style="display: block; margin-bottom: 15px;"></div>
                    <input type="hidden" id="appointmentDateFilter" value="">
                    <div style="display: flex; gap: 5px;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointments List (Right) -->
        <div class="col-md-8">
            <!-- Appointments List -->
            <div class="card">
                <div class="card-header border-0 pb-3">
                    <h6 class="mb-0">Rejected Appointments</h6>
                </div>
                <div class="card-body">
                    <div th:if="${rejectedAppointments.isEmpty()}" class="text-center py-5">
                        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #ddd;"></i>
                        <p class="text-muted mt-3">No rejected appointments</p>
                        <a th:href="@{/appointments/my-schedule}" class="btn btn-primary btn-sm">Back to Schedule</a>
                    </div>
                    
                    <div th:unless="${rejectedAppointments.isEmpty()}" class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Student</th>
                                    <th>Date & Time</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="apt : ${rejectedAppointments}" 
                                    th:attr="data-date=${#temporals.format(apt.appointmentDate, 'yyyy-MM-dd')}, 
                                             data-time=${#temporals.format(apt.timeSlotStart, 'HH:mm')}">
                                    <td>
                                        <h6 class="mb-0" th:text="${apt.student.name}">Student Name</h6>
                                        <small class="text-muted" th:text="${apt.student.email}">email@example.com</small>
                                    </td>
                                    <td>
                                        <span th:text="${#temporals.format(apt.appointmentDate, 'dd MMM yyyy')}">Date</span>
                                        <br>
                                        <small class="text-muted" th:text="${apt.timeSlotStart} + ' - ' + ${apt.timeSlotEnd}">Time</small>
                                    </td>
                                    <td>
                                        <span th:text="${#temporals.format(apt.timeSlotStart, 'HH:mm')} + ' - ' + ${#temporals.format(apt.timeSlotEnd, 'HH:mm')}">Duration</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger" th:text="${apt.status}">REJECTED</span>
                                    </td>
                                    <td>
                                        <span th:if="${apt.notes == null or apt.notes == ''}" class="text-muted">-</span>
                                        <span th:unless="${apt.notes == null or apt.notes == ''}" 
                                              th:title="${apt.notes}" 
                                              class="d-inline-block text-truncate" 
                                              style="max-width: 150px;" 
                                              th:text="${apt.notes}">Notes</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let allAppointments = [];
    let currentDate = new Date();
    
    // Helper function to get local date string without timezone issues
    function getLocalDateString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
        allAppointments = Array.from(document.querySelectorAll('tbody tr'));
        renderCalendar();
    });

    function renderCalendar() {
        const container = document.getElementById('calendarContainer');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const today = new Date();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        let html = `
            <div class="calendar" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white; width: 300px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <button onclick="previousMonth()" style="background: none; border: none; cursor: pointer; font-size: 18px;">‹</button>
                    <span style="font-weight: 600; margin: 0 15px; display: inline-block; min-width: 150px;">
                        ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                    </span>
                    <button onclick="nextMonth()" style="background: none; border: none; cursor: pointer; font-size: 18px;">›</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center;">
        `;
        
        // Day headers
        const dayHeaders = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
        dayHeaders.forEach(day => {
            html += `<div style="font-weight: 600; font-size: 12px; color: #667eea; padding: 5px;">${day}</div>`;
        });
        
        // Empty cells before first day
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += `<div style="padding: 5px;"></div>`;
        }
        
        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const cellDate = new Date(year, month, day);
            const dateStr = getLocalDateString(cellDate);
            const isToday = cellDate.toDateString() === today.toDateString();
            const isSelected = document.getElementById('appointmentDateFilter').value === dateStr;
            const hasAppointments = Array.from(document.querySelectorAll('tbody tr:not([style*="display: none"])')).some(row => row.getAttribute('data-date') === dateStr);
            
            let cellStyle = 'padding: 8px; cursor: pointer; border-radius: 4px; font-size: 14px; ';
            
            if (isSelected) {
                cellStyle += 'background: #dc3545; color: white; font-weight: 600;';
            } else if (isToday) {
                cellStyle += 'background: #f0f0f0; font-weight: 600; border: 2px solid #dc3545;';
            } else if (hasAppointments) {
                cellStyle += 'background: #ffe0e0; color: #dc3545; font-weight: 500;';
            } else {
                cellStyle += 'color: #333;';
            }
            
            html += `
                <div style="${cellStyle}" onclick="selectDate('${dateStr}')" title="${hasAppointments ? 'Has rejected appointments' : 'No appointments'}">
                    ${day}
                </div>
            `;
        }
        
        html += `
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="clearCalendar()" style="background: #f0f0f0; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        Clear
                    </button>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }
    
    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }
    
    function selectDate(dateStr) {
        document.getElementById('appointmentDateFilter').value = dateStr;
        filterAppointments();
        renderCalendar();
    }
    
    function clearCalendar() {
        // Clear also resets to today
        resetDateFilter();
    }

    function filterAppointments() {
        const selectedDate = document.getElementById('appointmentDateFilter').value;
        const rows = document.querySelectorAll('tbody tr');
        const table = document.querySelector('table');
        const emptyMessage = document.querySelector('.text-center.py-5');
        
        let visibleCount = 0;
        
        rows.forEach(row => {
            const rowDate = row.getAttribute('data-date');
            
            if (selectedDate === '' || rowDate === selectedDate) {
                row.style.display = 'table-row';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show/hide empty message
        if (visibleCount === 0) {
            if (table) table.style.display = 'none';
            if (emptyMessage) emptyMessage.style.display = 'block';
        } else {
            if (table) table.style.display = 'table';
            if (emptyMessage) emptyMessage.style.display = 'none';
        }
        
        // Sort visible rows by time (ascending)
        sortRowsByTime();
    }
    
    function sortRowsByTime() {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            // Only sort visible rows
            if (a.style.display === 'none' || b.style.display === 'none') {
                return 0;
            }
            
            const timeA = a.getAttribute('data-time');
            const timeB = b.getAttribute('data-time');
            
            return timeA.localeCompare(timeB);
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function resetDateFilter() {
        // Reset to today's date
        const today = new Date();
        const todayStr = getLocalDateString(today);
        document.getElementById('appointmentDateFilter').value = todayStr;
        currentDate = new Date(today); // Reset the current month view too
        filterAppointments();
        renderCalendar();
    }
</script>

<style>
    .form-control {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9ff;
    }

    .badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
    }

    .btn-outline-secondary:hover {
        background-color: #667eea;
        border-color: #667eea;
        color: white;
    }
</style>
