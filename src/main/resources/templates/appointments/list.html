<!-- Student Appointments List -->
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-2"><i class="bi bi-calendar-check"></i> My Appointments</h1>
            <p class="text-muted">View and manage your telehealth sessions with mental health professionals</p>
        </div>
        <div class="col-md-4 text-end">
            <a th:href="@{/appointments/book}" class="btn btn-primary">
                <i class="bi bi-calendar-plus"></i> Book New Appointment
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Calendar Section (Left) -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-body" style="padding: 15px;">
                    <label style="font-weight: 600; color: #333; margin-bottom: 15px; display: block;">
                        <i class="bi bi-calendar"></i> Select Date
                    </label>
                    <div id="calendarContainer" style="display: block; margin-bottom: 15px;"></div>
                    <input type="hidden" id="appointmentDateFilter" value="">
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetDateFilter()" title="Show all appointments" style="flex: 1;">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="window.location.href='/mentalhealthhub/appointments/rejected'" style="flex: 1;">
                            <i class="bi bi-calendar-x"></i> Rejected
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointments List (Right) -->
        <div class="col-md-8">
            <!-- Appointments List -->
            <div class="card">
                <div class="card-header border-0 pb-3">
                    <h6 class="mb-0">Your Scheduled Appointments</h6>
                </div>
                <div class="card-body">
                    <div th:if="${appointments.isEmpty()}" class="text-center py-5">
                        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #ddd;"></i>
                        <p class="text-muted mt-3">No appointments scheduled yet</p>
                        <a th:href="@{/appointments/book}" class="btn btn-primary btn-sm">Schedule Now</a>
                    </div>
                    
                    <div th:unless="${appointments.isEmpty()}" class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Professional</th>
                                    <th>Date & Time</th>
                                    <th>Report ID</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="apt : ${appointments}" th:attr="data-date=${#temporals.format(apt.appointmentDate, 'yyyy-MM-dd')}, data-time=${#temporals.format(apt.timeSlotStart, 'HH:mm')}, data-status=${apt.status}">
                                    <td>
                                        <h6 class="mb-0" th:text="${apt.professional.name}">Professional Name</h6>
                                        <small class="text-muted" th:text="${apt.professional.email}">email@example.com</small>
                                    </td>
                                    <td>
                                        <span th:text="${#temporals.format(apt.appointmentDate, 'dd MMM yyyy')}">Date</span>
                                        <br>
                                        <small class="text-muted" th:text="${apt.timeSlotStart} + ' - ' + ${apt.timeSlotEnd}">Time</small>
                                    </td>
                                    <td>
                                        <span th:if="${apt.reportId != null}" th:text="'#' + ${apt.reportId}">Report ID</span>
                                        <span th:unless="${apt.reportId != null}" class="text-muted">-</span>
                                    </td>
                                    <td>
                                        <span th:text="${#temporals.format(apt.timeSlotStart, 'HH:mm')} + ' - ' + ${#temporals.format(apt.timeSlotEnd, 'HH:mm')}">Duration</span>
                                    </td>
                                    <td>
                                        <span class="badge" th:classappend="${apt.status.toString() == 'PENDING' ? 'bg-warning' : (apt.status.toString() == 'APPROVED' ? 'bg-success' : (apt.status.toString() == 'STUDENT_PROPOSED' ? 'bg-info' : 'bg-danger'))}" 
                                              th:text="${apt.status}">Status</span>
                                    </td>
                                    <td>
                                        <span th:if="${apt.notes == null or apt.notes == ''}" class="text-muted">-</span>
                                        <span th:unless="${apt.notes == null or apt.notes == ''}" title="" th:title="${apt.notes}" class="d-inline-block text-truncate" style="max-width: 200px;" th:text="${apt.notes}">Notes</span>
                                    </td>
                                    <td>
                                        <!-- Show approve/reject buttons only for PENDING appointments with reportId (professional-created) -->
                                        <th:block th:if="${apt.status.toString() == 'PENDING' && apt.reportId != null}">
                                            <button class="btn btn-sm btn-success me-2" th:onclick="'studentApproveAppointment(' + ${apt.id} + ')'">
                                                <i class="bi bi-check-circle"></i> Approve
                                            </button>
                                            <button class="btn btn-sm btn-warning" th:onclick="'openRejectDialog(' + ${apt.id} + ')'">
                                                <i class="bi bi-x-circle"></i> Suggest Time
                                            </button>
                                        </th:block>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let allAppointments = [];
    let currentDate = new Date();
    
    // Helper function to get local date string without timezone issues
    function getLocalDateString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // Initialize calendar and date filter
    document.addEventListener('DOMContentLoaded', function() {
        allAppointments = Array.from(document.querySelectorAll('tbody tr'));
        // Auto-select today's date
        const today = new Date();
        const todayStr = getLocalDateString(today);
        selectDate(todayStr);
        renderCalendar();
        
        // Set minimum date to today for suggestion input (past timeslots will be filtered)
        document.getElementById('suggestedDateInput').min = todayStr;
    });

    function renderCalendar() {
        const container = document.getElementById('calendarContainer');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const today = new Date();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        let html = `
            <div class="calendar" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white; width: 300px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <button onclick="previousMonth()" style="background: none; border: none; cursor: pointer; font-size: 18px;">‹</button>
                    <span style="font-weight: 600; margin: 0 15px; display: inline-block; min-width: 150px;">
                        ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                    </span>
                    <button onclick="nextMonth()" style="background: none; border: none; cursor: pointer; font-size: 18px;">›</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center;">
        `;
        
        // Day headers
        const dayHeaders = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
        dayHeaders.forEach(day => {
            html += `<div style="font-weight: 600; font-size: 12px; color: #667eea; padding: 5px;">${day}</div>`;
        });
        
        // Empty cells before first day
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += `<div style="padding: 5px;"></div>`;
        }
        
        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const cellDate = new Date(year, month, day);
            const dateStr = getLocalDateString(cellDate);
            const isToday = cellDate.toDateString() === today.toDateString();
            const isSelected = document.getElementById('appointmentDateFilter').value === dateStr;
            const hasAppointments = Array.from(document.querySelectorAll('tbody tr')).some(row => row.getAttribute('data-date') === dateStr);
            
            let cellStyle = 'padding: 8px; cursor: pointer; border-radius: 4px; font-size: 14px; ';
            let cellClass = '';
            
            if (isSelected) {
                cellStyle += 'background: #667eea; color: white; font-weight: 600;';
            } else if (isToday) {
                cellStyle += 'background: #f0f0f0; font-weight: 600; border: 2px solid #667eea;';
            } else if (hasAppointments) {
                cellStyle += 'background: #e7f3ff; color: #667eea; font-weight: 500;';
            } else {
                cellStyle += 'color: #333;';
            }
            
            html += `
                <div style="${cellStyle}" onclick="selectDate('${dateStr}')" title="${hasAppointments ? 'Has appointments' : 'No appointments'}">
                    ${day}
                </div>
            `;
        }
        
        html += `
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="clearCalendar()" style="background: #f0f0f0; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        Clear
                    </button>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }
    
    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }
    
    function selectDate(dateStr) {
        document.getElementById('appointmentDateFilter').value = dateStr;
        filterAppointmentsByDate(dateStr);
        renderCalendar();
    }

    function filterAppointmentsByDate(selectedDate) {
        const rows = document.querySelectorAll('tbody tr');
        const table = document.querySelector('table');
        const emptyMessage = document.querySelector('.text-center.py-5');
        
        let visibleCount = 0;
        
        rows.forEach(row => {
            const rowDate = row.getAttribute('data-date');
            
            if (selectedDate === '' || rowDate === selectedDate) {
                row.style.display = 'table-row';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show/hide empty message
        if (visibleCount === 0) {
            if (table) table.style.display = 'none';
            if (emptyMessage) emptyMessage.style.display = 'block';
        } else {
            if (table) table.style.display = 'table';
            if (emptyMessage) emptyMessage.style.display = 'none';
        }
        
        // Sort visible rows by time (ascending)
        sortRowsByTime();
    }
    
    function sortRowsByTime() {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            // Only sort visible rows
            if (a.style.display === 'none' || b.style.display === 'none') {
                return 0;
            }
            
            const timeA = a.getAttribute('data-time');
            const timeB = b.getAttribute('data-time');
            
            return timeA.localeCompare(timeB);
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function resetDateFilter() {
        // Reset to today's date
        const today = new Date();
        const todayStr = getLocalDateString(today);
        document.getElementById('appointmentDateFilter').value = todayStr;
        currentDate = new Date(today); // Reset the current month view too
        filterAppointmentsByDate(todayStr);
        renderCalendar();
    }

    function clearCalendar() {
        // Clear also resets to today
        resetDateFilter();
    }

    // ==================== Student Appointment Actions ====================
    /**
     * Student approves a pending appointment from professional
     */
    function studentApproveAppointment(appointmentId) {
        if (confirm('Are you sure you want to approve this appointment?')) {
            fetch(`/mentalhealthhub/appointments/${appointmentId}/student-approve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                alert('Appointment approved successfully!');
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to approve appointment: ' + error.message);
            });
        }
    }

    /**
     * Open dialog to select new date/time and reject appointment
     */
    function openRejectDialog(appointmentId) {
        const dialog = document.getElementById('rejectAppointmentModal');
        dialog.setAttribute('data-appointment-id', appointmentId);
        
        // Initialize calendar for date selection
        const modal = new bootstrap.Modal(dialog);
        modal.show();
        
        // Reset form
        document.getElementById('rejectForm').reset();
        document.getElementById('selectedSuggestedDate').value = '';
        document.getElementById('suggestedTimeSlots').innerHTML = '';
    }

    let suggestedTimeSlotData = [];
    let selectedSuggestedSlots = [];

    /**
     * Load available time slots for selected date
     */
    function loadSuggestedTimeSlots() {
        const date = document.getElementById('suggestedDateInput').value;
        const appointmentId = document.getElementById('rejectAppointmentModal').getAttribute('data-appointment-id');
        
        if (!date) {
            document.getElementById('suggestedTimeSlots').innerHTML = '<p class="text-muted">Please select a date</p>';
            return;
        }
        
        fetch(`/mentalhealthhub/appointments/${appointmentId}/available-slots?date=${date}`)
            .then(response => response.json())
            .then(slots => {
                // Filter out past time slots if date is today
                const today = new Date();
                const selectedDate = new Date(date + 'T00:00:00');
                const isToday = today.toDateString() === selectedDate.toDateString();
                
                if (isToday) {
                    const currentHour = today.getHours();
                    const currentMinutes = today.getMinutes();
                    
                    slots = slots.filter(slot => {
                        const [hours, minutes] = slot.startTime.split(':');
                        return parseInt(hours) > currentHour || (parseInt(hours) === currentHour && parseInt(minutes) > currentMinutes);
                    });
                }
                
                suggestedTimeSlotData = slots;
                selectedSuggestedSlots = [];
                
                let html = '';
                if (slots.length === 0) {
                    html = '<p class="text-muted">No available time slots for this date</p>';
                } else {
                    html = '<div class="time-slots" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">';
                    slots.forEach((slot, index) => {
                        const displayTime = slot.startTime + ' - ' + slot.endTime;
                        const slotId = `suggested_slot_${index}`;
                        html += `
                            <input type="checkbox" class="btn-check suggested-time-slot-checkbox" id="${slotId}" 
                                   data-index="${index}" data-start="${slot.startTime}" data-end="${slot.endTime}"
                                   onchange="handleSuggestedSlotSelection(${index})">
                            <label class="btn btn-outline-primary w-100" for="${slotId}" style="cursor: pointer;">
                                ${displayTime}
                            </label>
                        `;
                    });
                    html += '</div>';
                    html += '<small class="text-danger d-none mt-2" id="suggestedSlotError">Please select continuous time slots without gaps</small>';
                    html += '<div class="alert alert-info d-none mt-3" id="suggestedSlotInfo" role="alert"><small><strong>Selected:</strong> <span id="suggestedSlotsDisplay">No slots selected</span></small></div>';
                }
                document.getElementById('suggestedTimeSlots').innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading time slots:', error);
                document.getElementById('suggestedTimeSlots').innerHTML = '<p class="text-danger">Error loading time slots</p>';
            });
    }

    /**
     * Handle suggested slot selection with continuous validation
     */
    function handleSuggestedSlotSelection(index) {
        const checkbox = document.querySelector(`.suggested-time-slot-checkbox[data-index="${index}"]`);
        
        if (checkbox.checked) {
            selectedSuggestedSlots.push(index);
        } else {
            selectedSuggestedSlots = selectedSuggestedSlots.filter(idx => idx !== index);
        }
        
        // Validate that selected slots are continuous (no gaps in actual times)
        if (selectedSuggestedSlots.length > 1) {
            selectedSuggestedSlots.sort((a, b) => a - b);
            
            // Check if the actual times are continuous (end time of one slot = start time of next)
            let isContinuous = true;
            for (let i = 0; i < selectedSuggestedSlots.length - 1; i++) {
                const currentSlotIndex = selectedSuggestedSlots[i];
                const nextSlotIndex = selectedSuggestedSlots[i + 1];
                
                const currentSlot = suggestedTimeSlotData[currentSlotIndex];
                const nextSlot = suggestedTimeSlotData[nextSlotIndex];
                
                // Check if end time of current equals start time of next
                if (currentSlot.endTime !== nextSlot.startTime) {
                    isContinuous = false;
                    console.log(`Gap detected: ${currentSlot.endTime} != ${nextSlot.startTime}`);
                    break;
                }
            }
            
            if (!isContinuous) {
                // Uncheck the slot
                checkbox.checked = false;
                selectedSuggestedSlots = selectedSuggestedSlots.filter(idx => idx !== index);
                document.getElementById('suggestedSlotError').classList.remove('d-none');
                setTimeout(() => {
                    document.getElementById('suggestedSlotError').classList.add('d-none');
                }, 3000);
                return;
            }
        }
        
        updateSuggestedSlotDisplay();
    }

    /**
     * Update the display of selected suggested slots
     */
    function updateSuggestedSlotDisplay() {
        if (selectedSuggestedSlots.length === 0) {
            document.getElementById('suggestedSlotInfo').classList.add('d-none');
            document.getElementById('selectedSuggestedDate').value = '';
            document.getElementById('selectedSuggestedStartTime').value = '';
            document.getElementById('selectedSuggestedEndTime').value = '';
            return;
        }
        
        selectedSuggestedSlots.sort((a, b) => a - b);
        const startSlotIndex = selectedSuggestedSlots[0];
        const endSlotIndex = selectedSuggestedSlots[selectedSuggestedSlots.length - 1];
        
        const startTime = suggestedTimeSlotData[startSlotIndex].startTime;
        const endTime = suggestedTimeSlotData[endSlotIndex].endTime;
        
        const selectedDisplay = startTime + ' - ' + endTime;
        
        document.getElementById('suggestedSlotsDisplay').textContent = selectedDisplay;
        document.getElementById('suggestedSlotInfo').classList.remove('d-none');
        
        const date = document.getElementById('suggestedDateInput').value;
        document.getElementById('selectedSuggestedDate').value = date;
        document.getElementById('selectedSuggestedStartTime').value = startTime;
        document.getElementById('selectedSuggestedEndTime').value = endTime;
    }


    /**
     * Submit reject and suggest
     */
    function submitRejectAndSuggest() {
        const appointmentId = document.getElementById('rejectAppointmentModal').getAttribute('data-appointment-id');
        const date = document.getElementById('selectedSuggestedDate').value;
        const startTime = document.getElementById('selectedSuggestedStartTime').value;
        const endTime = document.getElementById('selectedSuggestedEndTime').value;
        
        if (!date || !startTime || !endTime) {
            alert('Please select a date and time slot');
            return;
        }
        
        // Validate continuous slots before submission
        if (selectedSuggestedSlots.length > 1) {
            const sortedSlots = [...selectedSuggestedSlots].sort((a, b) => a - b);
            let isContinuous = true;
            
            for (let i = 0; i < sortedSlots.length - 1; i++) {
                const currentSlotIndex = sortedSlots[i];
                const nextSlotIndex = sortedSlots[i + 1];
                
                const currentSlot = suggestedTimeSlotData[currentSlotIndex];
                const nextSlot = suggestedTimeSlotData[nextSlotIndex];
                
                if (currentSlot.endTime !== nextSlot.startTime) {
                    isContinuous = false;
                    break;
                }
            }
            
            if (!isContinuous) {
                document.getElementById('suggestedSlotError').classList.remove('d-none');
                document.getElementById('suggestedSlotError').innerHTML = 'Please select continuous time slots without gaps';
                setTimeout(() => {
                    document.getElementById('suggestedSlotError').classList.add('d-none');
                }, 4000);
                return;
            }
        }
        
        const url = new URL(`/mentalhealthhub/appointments/${appointmentId}/student-reject-suggest`, window.location.origin);
        url.searchParams.append('suggestedDate', date);
        url.searchParams.append('suggestedStartTime', startTime);
        url.searchParams.append('suggestedEndTime', endTime);
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text); });
            }
            return response.json();
        })
        .then(data => {
            alert('Appointment rejection with suggestion submitted successfully!');
            bootstrap.Modal.getInstance(document.getElementById('rejectAppointmentModal')).hide();
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to submit rejection: ' + error.message);
        });
    }
</script>

<style>
    .form-control {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9ff;
    }

    .badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
    }

    .btn-outline-secondary:hover {
        background-color: #667eea;
        border-color: #667eea;
        color: white;
    }

    .time-slot-btn.active {
        background-color: #667eea !important;
        color: white !important;
        border-color: #667eea !important;
    }
</style>

<!-- Modal for Rejecting and Suggesting Alternative Time -->
<div class="modal fade" id="rejectAppointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-event"></i> Suggest Alternative Appointment Time
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rejectForm">
                    <div class="mb-4">
                        <label class="form-label fw-600">Select New Date</label>
                        <input type="date" id="suggestedDateInput" class="form-control" 
                               onchange="loadSuggestedTimeSlots()" required>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-600">Select Time Slot</label>
                        <div id="suggestedTimeSlots" class="text-muted">
                            <p>Please select a date first</p>
                        </div>
                    </div>

                    <!-- Hidden fields to store selection -->
                    <input type="hidden" id="selectedSuggestedDate">
                    <input type="hidden" id="selectedSuggestedStartTime">
                    <input type="hidden" id="selectedSuggestedEndTime">
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitRejectAndSuggest()">
                    <i class="bi bi-check-circle"></i> Submit Suggestion
                </button>
            </div>
        </div>
    </div>
</div>
